name: Increment Build Number

on:
  pull_request:
    types: [closed]
    branches:
      - sandbox_branch # змініть на основну гілку, куди мерджаться PR

# Додати дозволи для запису в репозиторій
permissions:
  contents: write

jobs:
  increment-build:
    name: Increment Build Number
    runs-on: ubuntu-latest

    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }} # цільова гілка (куди мерджиться PR)

      - name: Increment patch version
        run: |

          FULL_VERSION=$(grep '^version: ' pubspec.yaml | sed 's/version: //')
          SEMANTIC_VERSION=$(echo $FULL_VERSION | awk -F"+" '{print $1}')
          BUILD_NUMBER=$(echo $FULL_VERSION | awk -F"+" '{print $2}')
          MAJOR=$(echo $SEMANTIC_VERSION | awk -F"." '{print $1}')
          MINOR=$(echo $SEMANTIC_VERSION | awk -F"." '{print $2}')
          PATCH=$(echo $SEMANTIC_VERSION | awk -F"." '{print $3}')
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH+$BUILD_NUMBER"
          sed -i "s/version: $FULL_VERSION/version: $NEW_VERSION/" pubspec.yaml
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add pubspec.yaml
          git commit -m "Increment patch version to $NEW_VERSION"
          git push origin ${{ github.event.pull_request.base.ref }}
